<?xml version="1.0" encoding="UTF-8"?>
<!-- camel-k: language=xml -->

<routes xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://camel.apache.org/schema/spring"
        xsi:schemaLocation="
            http://camel.apache.org/schema/spring
            https://camel.apache.org/schema/spring/camel-spring.xsd">


	<!-- Write your routes here, for example: -->
    <route id="DEPRECATED">
        <from uri="servlet:/DEPRECATED?disableStreamCache=true"/>
        <!-- <from uri="servlet:/zip"/> -->
        <!-- <from uri="servlet:/test"/> -->

        <log message="handling input stream"/>
<!--         <to uri="file:../data?fileName=output"/>
 -->

        <removeHeaders pattern="*"/>
        <!-- Unzip -->
        <unmarshal>
            <zipFile usingIterator="true"/>
        </unmarshal>

        <split streaming="true" parallelProcessing="false">
            <simple>${body}</simple>
            <!-- <to uri="log:debug?showAll=true"/> -->
            <!-- <log message="${header.CamelFileName}: ${body}"/> -->
            <to uri="direct:store-image"/>
        </split>

        <log message="done streaming"/>
        <setBody>
            <simple>done</simple>
        </setBody>
    </route>


    <route id="newzip">
        <from uri="servlet:/zip?disableStreamCache=true"/>



        <to uri="file:ziptemp?fileName=images.zip"/>
        <log message="images.zip created"/>


        <to uri="direct:check-pending-work"/>

        <when>
            <simple>${exchangeProperty.busy} == true</simple>
            <log message="busy: ignoring ZIP request"/>
            <to uri="exec:rm?args=ziptemp/images.zip"/>
            <setHeader name="CamelHttpResponseCode">
                <constant>425</constant>
            </setHeader>
            <setBody>
                <constant>{"status":"busy"}</constant>
            </setBody>
            <stop/>
        </when>

        <to uri="exec:mv?args=ziptemp/images.zip zip/images.zip"/>
        <!-- <log message="renamed to images.zip.done"/> -->
        <setBody>
            <simple>done</simple>
        </setBody>
    </route>


    <route id="unzip">
        <!-- <from uri="file:zip?delete=true&amp;doneFileName=${file:name}.done"/> -->
        <from uri="file:zip?delete=true"/>
        <log message="unzipping..."/>
        <to uri="exec:unzip?args=-d tempfiles zip/images.zip"/>
        <log message="unzip completed."/>

    </route>


    <route id="store-image">
        <from uri="direct:store-image"/>
        <to uri="file:tempfiles?doneFileName=${file:name}.done"/>
    </route>

    <route id="file-reader">
        <!-- <from uri="file:tempfiles?delete=true&amp;recursive=true&amp;doneFileName=${file:name}.done"/> -->
        <from uri="file:tempfiles?delete=true&amp;recursive=true"/>
        <!-- <log message="file is: ${header.CamelFileName}"/> -->

        <choice>
            <when>
                <simple>${header.CamelFileName} regex "images/.*/.*\.(jpg|jpeg|JPG|JPEG)"</simple>

                <!-- <log message="valid: ${header.CamelFileName}"/> -->
                <to uri="direct:store-image-s3"/>

            </when>
            <otherwise>
                <log message="(only /images/class-x/*.jpg) IGNORED: ${header.CamelFileName}"/>
            </otherwise>
        </choice>

        <!-- RESET BODY and CHECK ASYNC (wireTap) -->
        <setBody>
            <constant>trigger</constant>
        </setBody>
        <wireTap uri="direct:check-pending-work"/>

    </route>

    <route id="store-image-s3">
        <from uri="direct:store-image-s3"/>

        <setHeader name="CamelAwsS3Key">
            <simple>${header.CamelFileName}</simple>
        </setHeader>

        <setHeader name="CamelAwsS3ContentType">
            <simple>image/jpeg</simple>
        </setHeader>

        <to uri="aws2-s3:data"/>
        <!-- <log message="file stored: ${header.CamelAwsS3Key}"/> -->
    </route>


    <route id="check-pending-work">
        <from uri="direct:check-pending-work"/>

        <setProperty name="messagein">
            <simple>${body}</simple>
        </setProperty>

        <setProperty name="busy">
            <constant>true</constant>
        </setProperty>

        <to uri="exec:find?args= tempfiles -type f"/>

        <setBody>
            <simple resultType="String">${body}</simple>
        </setBody>
        <setBody>
            <simple>${body.trim()}</simple>
        </setBody>

        <choice>
            <when>
                <simple>${body} == ""</simple>
                <setProperty name="busy">
                    <constant>false</constant>
                </setProperty>
                <log message="NO PENDING WORK !!"/>
                <when>
                    <simple>${exchangeProperty.messagein} == 'trigger'</simple>
                    <log message="Triggering pipeline..."/>
                    <to uri="direct:trigger-pipeline"/>
                </when>
            </when>
        </choice>
    </route>

    <route id="trigger-pipeline">
        <from uri="direct:trigger-pipeline"/>
        <setBody>
            <simple>dummy</simple>
        </setBody>
        <log message="sending event: ${body}"/>
        <to uri="kafka:trigger"/>
    </route>

</routes>
